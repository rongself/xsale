define(["knockout","viewmodel/saleProduct","knockoutMapping","formPost","message","cookie","validation","validationConfig"],function(e,t,n,r,i){return function(){var s=this;s.saleProducts=e.observableArray(null),s.orderTime=e.observable(moment().format("YYYY-MM-DD")).extend({required:{message:"售出日期不能为空"}}),s.customerName=e.observable(),s.phoneNumber=e.observable().extend({number:{message:"手机号格式不正确"}}),s.totalPrice=e.computed(function(){var e=0;for(var t in s.saleProducts())e+=parseFloat(s.saleProducts()[t].price())*parseInt(s.saleProducts()[t].quantity());return e}),s.addItem=function(n){var r=new t;r.sku(n.sku()),r.quantity(n.quantity()),r.price(n.price()),r.remark(n.remark());var i=e.utils.arrayFirst(s.saleProducts(),function(e){return e.sku()===n.sku()});i?(s.saleProducts.remove(i),s.saleProducts.push(r)):(s.saleProducts.push(r),$(document).trigger("saleRecord.addItem"))},s.removeItem=function(e){s.saleProducts.remove(e)},s.reset=function(){s.saleProducts().length>0&&s.saleProducts.removeAll(),s.phoneNumber(null),s.customerName(null),$(document).trigger("saleRecord.reset")},s.submitAndContinue=function(e){if(s.phoneNumber.isValidating())return $("#submitTo").button("loading"),setTimeout(function(){s.submit()},50),!1;$("#submitTo").button("reset");if(!(s!=null&&typeof s.saleProducts()=="object"&&s.saleProducts().length>0))return i.warning("销售记录中还未加入任何产品"),!1;var t=n.toJSON(s);r.submit({viewModel:s,url:"/sale-record/create-record",data:{saleRecord:t},success:function(){s.reset(),i.success("销售记录已成功提交"),$(document).trigger("saleRecord.submitSuccess"),typeof e=="function"&&e()}})},s.submit=function(){s.submitAndContinue(function(){location.href="/sale-record/index"})},s.show=function(e){$(e).hide().slideDown()},s.loadCache=function(){if($.cookie("saleRecord")!=undefined){var e=n.fromJSON($.cookie("saleRecord"));e.orderTime!=undefined?s.orderTime(e.orderTime()):"",e.phoneNumber!=undefined?s.phoneNumber(e.phoneNumber()):"";var t=e.saleProducts();for(var r in t)s.saleProducts.push(t[r]);return!0}return!1},s.setCache=function(){$.removeCookie("saleRecord"),$.cookie("saleRecord",n.toJSON(s),{expires:2})},s.clearCache=function(){$.removeCookie("saleRecord")},s.init=function(){s.loadCache()&&i.info("已载入上次未保存的数据,清除数据请点击右上角按钮清空已添加产品"),$(document).on({"saleRecord.addItem":function(){s.setCache()},"saleRecord.submitSuccess":function(){s.clearCache()},"saleRecord.reset":function(){s.clearCache()}})}}});