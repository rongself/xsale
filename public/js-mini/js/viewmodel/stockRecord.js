define(["knockout","viewmodel/stockProduct","knockoutMapping","formPost","message","cookie"],function(e,t,n,r,i){return function(){var t=this;t.stockProducts=e.observableArray(null),t.stockTime=e.observable(moment().format("YYYY-MM-DD")).extend({required:{message:"售出日期不能为空"}}),t.totalPrice=e.computed(function(){var e=0;for(var n in t.stockProducts())e+=parseFloat(t.stockProducts()[n].cost())*parseInt(t.stockProducts()[n].stock());return e}),t.loadCache=function(){if($.cookie("stockRecord")!=undefined){var e=n.fromJSON($.cookie("stockRecord"));e.stockTime!=undefined&&t.stockTime(e.stockTime());var r=e.stockProducts();for(var i in r)t.stockProducts.push(r[i]);return!0}return!1},t.setCache=function(){$.removeCookie("stockRecord"),$.cookie("stockRecord",n.toJSON(t),{expires:2})},t.clearCache=function(){$.removeCookie("stockRecord")},t.addItem=function(r){var i=n.toJSON(r),s=n.fromJSON(i),o=e.utils.arrayFirst(t.stockProducts(),function(e){return e.sku()===r.sku()});o?(t.stockProducts.remove(o),t.stockProducts.push(s)):(t.stockProducts.push(s),$(document).trigger("stockRecord.addItem"))},t.removeItem=function(e){t.stockProducts.remove(e)},t.clear=function(){t.stockProducts().length>0&&t.stockProducts.removeAll()},t.submitAndContinue=function(e){if(!(t!=null&&typeof t.stockProducts()=="object"&&t.stockProducts().length>0))return i.warning("进货单中还未加入任何产品"),!1;var s=n.toJSON(t);r.submit({viewModel:t,url:"/stock-record/create-record",data:{stockRecord:s},success:function(){t.reset(),i.success("进货单已成功提交"),$(document).trigger("stockRecord.submitSuccess"),typeof e=="function"&&e()}})},t.submit=function(){t.submitAndContinue(function(){location.href="/stock-record/index"})},t.reset=function(){t.clear(),$(document).trigger("stockRecord.reset")},t.init=function(){t.loadCache()&&i.info("已载入上次未保存的数据,清除数据请点击右上角按钮清空已添加产品"),$(document).on({"stockRecord.addItem":function(){t.setCache()},"stockRecord.submitSuccess":function(){t.clearCache()},"stockRecord.reset":function(){t.clearCache()}})}}});